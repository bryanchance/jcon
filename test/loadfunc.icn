#SRC: JCON

#  test dynamic loading, especially examples from the doc

procedure main()
   javaprocs()		# test separately compiled Java procedures
   genproc()		# generate, build, and test an Icon procedure
end

procedure javaprocs()
   local sum3, factors, threen, f, i

   sum3 := loadfunc("jfuncs.zip", "sum3")
   factors := loadfunc("jfuncs.zip", "factors")
   threen := loadfunc("jfuncs.zip", "threen")

   every f := sum3 | factors | threen do
      write(image(f), " : ", args(f), " args")

   write()
   write("sum3: ", sum3(5, 8, 11), " ", sum3(12.0, 23.7, "45.8"))

   write()
   every i := 24 | 30 | 45 | 48 | 60 | 120 do {
       writes("factors(", i, "): ")
       every writes(" ", factors(i))
       write()
   }

   write()
   every i := 1 to 30 do {
       writes("3n+1(", i, "): ")
       every writes(" ", threen(i))
       write()
   }
   return
end

procedure genproc()
   local f, p, i

   remove("tmp.icn")
   remove("tmp.zip")
   f := open("tmp.icn", "w") | stop("can't open tmp.icn")
   wproc(f)
   close(f)
   system("../bin/jcont -s -c tmp")
   p := loadfunc("tmp.zip", "inv")

   write()
   every i := 1 to 25 do 
      write("1/", i, " = ", p(i))
   remove("tmp.zip")
   remove("tmp.icn")
end

procedure wproc(f)
   every write(f, ![
      "procedure inv(x)", 
      "   return adiv(-1.0, x)",
      "end",
      "",
      "procedure adiv(a, b)",
      "   return abs(a) / b",
      "end"
   ]);
end
