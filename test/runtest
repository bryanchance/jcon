#!/bin/ksh
#
#  runtest [-JP] [file...] -- run test
#
#	-J	use Java compiler target  (icont -J)
#	-P	disable optimizer  (icont -P)

JCONT="../bin/jcont"
JCOPT="-s"

USAGE="$0 [-JP] [file...]"
while getopts :JP c; do
    case $c in
	J)	JCOPT="$JCOPT -J";;
	P)	JCOPT="$JCOPT -P";;
	*)	echo "usage: $USAGE" 1>&2; exit 1;;
    esac
done
shift $((OPTIND-1))

if [ $# = 0 ]; then
   set *.std
fi

ERRORS=0

for FNAME; do
    BASE=${FNAME%.*}
    echo ${BASE}:
    if [ ! -r $BASE.icn -o ! -r $BASE.std ]; then
	echo "   invalid test: missing $BASE.icn or $BASE.std"
	let 'ERRORS = ERRORS + 1'
	continue
    fi
    $JCONT $JCOPT $BASE
    if [ -r $BASE.dat ]; then
	./$BASE $BASE.dat <$BASE.dat >$BASE.out
    else
	./$BASE </dev/null >$BASE.out
    fi
    cmp $BASE.std $BASE.out || let 'ERRORS = ERRORS + 1'
done

case $ERRORS in
    0)  echo "Testing complete; no errors.";  exit 0;;
    1)  echo "Testing complete; ***** $ERRORS error. *****";  exit 1;;
    *)  echo "Testing complete; ***** $ERRORS errors. *****";  exit 1;;
esac
