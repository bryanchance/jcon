#!/bin/ksh
#
#  runtest [-JP] [file...] -- run test
#
#	-J	use Java compiler target  (icont -J)
#	-P	disable optimizer  (icont -P)

export JCONT="../bin/jcont"
export JCOPT="-s"

USAGE="$0 [-JP] [file...]"
while getopts :JP c; do
    case $c in
	J)	JCOPT="$JCOPT -J";;
	P)	JCOPT="$JCOPT -P";;
	*)	echo "usage: $USAGE" 1>&2; exit 1;;
    esac
done
shift $((OPTIND-1))

if [ $# = 0 ]; then
   set *.std
fi

FAILED=""

for FNAME; do
    BASE=${FNAME%.*}
    echo ${BASE}:
    if [ -r $BASE.sh ]; then
	sh $BASE.sh || FAILED="$FAILED $BASE"
	continue
    fi
    if [ ! -r $BASE.icn -o ! -r $BASE.std ]; then
	echo "   invalid test: missing $BASE.icn or $BASE.std"
	FAILED="$FAILED $BASE"
	continue
    fi
    $JCONT $JCOPT $BASE
    if [ -r $BASE.dat ]; then
	./$BASE $BASE.dat <$BASE.dat >$BASE.out
    else
	./$BASE </dev/null >$BASE.out
    fi
    cmp $BASE.std $BASE.out || FAILED="$FAILED $BASE"
done

case "X$FAILED"  in
    X)  echo "Testing successful.";  exit 0;;
    *)  echo "Testing FAILED for: $FAILED"; exit 1;;
esac
